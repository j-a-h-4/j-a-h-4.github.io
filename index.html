<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OMDb Selector (Secure)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f7f7f7; }
    .card { background: white; padding: 16px; border-radius: 8px; max-width: 600px; margin: auto; }
    input, select, button { padding: 8px; margin: 4px 0; border-radius: 4px; border: 1px solid #ccc; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; display: flex; justify-content: space-between; }
    .meta { font-size: 0.85em; color: #555; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Select a Movie/TV Show</h2>
    <label>Your Name: <input id="nameInput" type="text"></label><br>
    <label>Search: <input id="searchInput" type="text"></label>
    <select id="typeSelect">
      <option value="">Any</option>
      <option value="movie">Movie</option>
      <option value="series">Series</option>
      <option value="episode">Episode</option>
    </select>
    <button id="searchBtn">Search</button>

    <ul id="results"></ul>

    <div id="selectedBlock" style="display:none;">
      <h3>Selected</h3>
      <p id="selTitle"></p>
      <p id="selMeta" class="meta"></p>
    </div>
  </div>

  <script>
    const nameInput = document.getElementById('nameInput');
    const searchInput = document.getElementById('searchInput');
    const typeSelect = document.getElementById('typeSelect');
    const searchBtn = document.getElementById('searchBtn');
    const resultsUL = document.getElementById('results');
    const selectedBlock = document.getElementById('selectedBlock');
    const selTitle = document.getElementById('selTitle');
    const selMeta = document.getElementById('selMeta');

    searchBtn.onclick = async () => {
      const q = searchInput.value.trim();
      const type = typeSelect.value;
      if (!q) return alert('Enter a search term');

      resultsUL.innerHTML = '<li>Loading...</li>';
      const res = await fetch(`/api/search?q=${encodeURIComponent(q)}&type=${encodeURIComponent(type)}`);
      const data = await res.json();

      if (data.Response === 'False') {
        resultsUL.innerHTML = `<li>${data.Error}</li>`;
        return;
      }

      resultsUL.innerHTML = '';
      data.Search.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<div>
            <strong>${item.Title}</strong>
            <div class="meta">${item.Year} • ${item.Type}</div>
          </div>
          <button data-id="${item.imdbID}">Select</button>`;
        resultsUL.appendChild(li);
      });
    };

    resultsUL.onclick = async e => {
      if (e.target.tagName === 'BUTTON') {
        const imdbID = e.target.dataset.id;
        const res = await fetch(`/api/title?i=${encodeURIComponent(imdbID)}`);
        const data = await res.json();
        selTitle.textContent = data.Title;
        selMeta.textContent = `${data.Year} • ${data.Type} • ${data.imdbID}`;
        selectedBlock.style.display = 'block';
      }
    };
  </script>
</body>
</html>
